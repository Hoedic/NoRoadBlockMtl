<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>NoRoadBlockMtl</title>
<!--link href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" /-->
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://code.jquery.com/jquery-1.5.js"></script>
<script type="text/javascript">
  var directionDisplay;
  var directionsService = new google.maps.DirectionsService();
  var map;

//Set the path generated by Google as modifiable on the map by the user
var rendererOptions = {
  draggable: true
};

//Function called when loading the page
  function initialize() {
  	//Define the map
    directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
    var myCentre = new google.maps.LatLng(45.50, -73.55);
    var myOptions = {
      zoom:9,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      center: myCentre
    }

	//Set the DIV to be used to display the Google Map
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    directionsDisplay.setMap(map);


//Listener to track the changes in the path
//Disabled for the moment, it seems to create an infinite loop somewhere...

    google.maps.event.addListener(directionsDisplay, 'directions_changed', function() {
    //calcRoute();
	processRoute(directionsDisplay.directions);
   }); 

}


function calcRoute() {

	//Get the start and end point from the form  	
	  var start = document.getElementById("start").value;
	  var end = document.getElementById("end").value;

	//Prepare and send request to Google
    var request = {
        origin:start, 
        destination:end,
        travelMode: google.maps.DirectionsTravelMode.DRIVING
    };

  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    }
  });
  
  
  
   var mapBounds = map.getBounds();
   //alert (mapBounds);
	var northEast = mapBounds.getNorthEast();
	var southWest = mapBounds.getSouthWest();	
	var neLat = northEast.lat();
	var neLon = northEast.lng();
	var swLat = southWest.lat();
	var swLon = southWest.lng();
	var url = "http://96.21.124.183:8080/NoRoadBlockMtl/api/works.json?q=toto";
//	var query = "?nelat=" +  neLat + "&nelon=" + neLon + "&swlat=" + swLat + "&swlon=" + swLon;
//	alert(url + query);  
   
   $.getJSON(url,"",
  function(data) {


	for (i in data){
		var travaux = [];
		//alert(data[i]["name"]);
		
		for (j in data[i]["coordinates"]){
			var splited = data[i]["coordinates"][j].split(" ");
			var pointpassage = new google.maps.LatLng(splited[1], splited[0]);
			travaux.push(pointpassage);
//		alert(formated);
		}
		
		//alert("Taille du array" + travaux.length);
		
	   var marker = new google.maps.Marker({
   	   position: travaux[0], 
      		map: map, 
 			});
  		
		if (travaux.length > 1){		
  			var zeLigne = new google.maps.Polyline({
    			path: travaux,
    			strokeColor: "#FF0000",
    			strokeOpacity: 0.5,
    			strokeWeight: 6
  			});

  			zeLigne.setMap(map);
		}
	}
  
  });

}
  
function processRoute (result) {

		//Retrieve and format the path. Target format is "long1 lat1, long2 lat2, ..."
		var fullString = "";
	  	var myRoute = result.routes[0].overview_path;

	  	for (var i = 0; i < myRoute.length; i++) {
			var exploded = (myRoute[i] + ",").split(",");
			fullString +=  exploded[1].replace(")", "").substring(1, 11) + " " + exploded[0].replace("(", "").substring(0, 10) + ",";


/*
			//Small code to print all the points of the path on the map.
			var marker = new google.maps.Marker({position: myRoute[i], map: map});

			google.maps.event.addListener(marker, 'click', function() {
			  infowindow.open(map,marker);
			});*/
        }


	  fullString = fullString.replace(")", "");
	  fullString = fullString.replace("(", "");
	  
	  //Set the value of an hidden form field to be sent to the server.
	  var postValue = document.getElementById('hiddenpath');
	  postValue.value = fullString.substring(0, fullString.length - 2);

}   

function postNewRoute () {
	
		myObject = new Object();	
	
	  var postValue = document.getElementById('hiddenpath');
	  myObject.route = postValue.value;
	  myObject.userid = document.getElementById('userid').value;		  
	  myObject.name = document.getElementById('routename').value;		
	  var theData = JSON.stringify(myObject);
	//alert(theData);
		$.post('http://96.21.124.183:8080/NoRoadBlockMtl/api/routes.json', { data: theData});
}

function getListOfRoutes () {
	
	var userid = document.getElementById('getuserid').value;		  
	document.getElementById('listroutes').innerHTML = '&nbsp';
	document.getElementById('listtravaux').innerHTML = '&nbsp';	
	$.getJSON('http://96.21.124.183:8080/NoRoadBlockMtl/api/routes.json?userid=' + userid, function(data) {
		var futureHTML = "";
		for (i in data){
			var name = data[i]["name"];
		futureHTML += "<p>" + name + "("+ data[i]["id"] +")<br/>";
		futureHTML += '<input type="button" value="Check roadwork on this route" onclick="getWorkWithId('+   data[i]["id"] +')"/>';
		futureHTML += "</p>";
			//alert(name);
		}
		
		document.getElementById('listroutes').innerHTML = futureHTML;
	});

}

function getWorkWithId (workId) {

	document.getElementById('listroutes').innerHTML = '&nbsp';
	document.getElementById('listtravaux').innerHTML = '&nbsp';	

	$.getJSON('http://96.21.124.183:8080/NoRoadBlockMtl/api/works.json?routeid=' + workId , function(data) {
		var futureHTML = "";
		for (i in data){
		var name = data[i]["name"];
		futureHTML += "<p>" + name + "<br/>";
		futureHTML += "</p>";
			//alert(name);
		}
		
		document.getElementById('listtravaux').innerHTML = futureHTML;
	});

}

</script>
</head>
<body onload="initialize()">
<div>
<b>Start: </b> <input id="start" type="text" name="start" value="MontrÃ©al, qc"/>&nbsp;&nbsp;&nbsp;
<b>End: </b> <input id="end" type="text" name="end" value="Laval, qc"/>
<input type="button" value="Trace my route" onclick="calcRoute();"/>
<hr/>
<form action="postme.php" method="post">
<input type="hidden" name="hiddenpath" id="hiddenpath" value=""/>
<input type="hidden" name="distance" id="distance" value="distance" />
User id (for insert) : <input type="text" name="userid" id="userid" value="1" /><br/>
Name of the route : <input type="text" name="routename" id="routename" value="Montreal to Laval" /><br/>
<input type="button" value="Submit My Route"  onclick="postNewRoute()"/>
</form>
<hr/>
</div>
<div>&nbsp;</div>
<div id="leftone" style="width:30%; float:left">
Get list of routes for user 
<input type="text" name="getuserid" id="getuserid" size="2" value="1">
<input type="button" value="Get the list!" onclick="getListOfRoutes()"/>
<div id="listroutes"></div>
<div id="listtravaux"></div>
</div>
<div style="width:68%; height:500px" id="map_canvas"></div>
</body>
</html>
